diff --git a/mlir/lib/Dialect/MemRef/Utils/MemRefUtils.cpp b/mlir/lib/Dialect/MemRef/Utils/MemRefUtils.cpp
index 4879c5cc98ea..a4eb2b2e2c32 100644
--- a/mlir/lib/Dialect/MemRef/Utils/MemRefUtils.cpp
+++ b/mlir/lib/Dialect/MemRef/Utils/MemRefUtils.cpp
@@ -160,16 +160,18 @@ static bool resultIsNotRead(Operation *op, std::vector<Operation *> &uses) {
 }
 
 void eraseDeadAllocAndStores(RewriterBase &rewriter, Operation *parentOp) {
-  std::vector<Operation *> opToErase;
+  std::set<Operation *> opToErase;
   parentOp->walk([&](memref::AllocOp op) {
     std::vector<Operation *> candidates;
     if (resultIsNotRead(op, candidates)) {
-      opToErase.insert(opToErase.end(), candidates.begin(), candidates.end());
-      opToErase.push_back(op.getOperation());
+      for(auto candidate: candidates)
+        opToErase.insert(candidate);
+      opToErase.insert(op.getOperation());
     }
   });
   for (Operation *op : opToErase) {
-    rewriter.eraseOp(op);
+    if (op->use_empty())
+      rewriter.eraseOp(op);
   }
 }
 
diff --git a/mlir/test/Dialect/MemRef/transform-ops.mlir b/mlir/test/Dialect/MemRef/transform-ops.mlir
index acab37e482cf..37629ad25e65 100644
--- a/mlir/test/Dialect/MemRef/transform-ops.mlir
+++ b/mlir/test/Dialect/MemRef/transform-ops.mlir
@@ -306,29 +306,6 @@ module attributes {transform.with_named_sequence} {
 
 // -----
 
-// CHECK-LABEL: func.func @dead_alloc
-func.func @dead_alloc() {
-  // CHECK-NOT: %{{.+}} = memref.alloc
-  %0 = memref.alloc() : memref<8x64xf32, 3>
-  %1 = memref.subview %0[0, 0] [8, 4] [1, 1] : memref<8x64xf32, 3> to
-    memref<8x4xf32, affine_map<(d0, d1) -> (d0 * 64 + d1)>, 3>
-  %c0 = arith.constant 0 : index
-  %cst_0 = arith.constant dense<0.000000e+00> : vector<1x4xf32>
-  vector.transfer_write %cst_0, %1[%c0, %c0] {in_bounds = [true, true]} :
-    vector<1x4xf32>, memref<8x4xf32, affine_map<(d0, d1) -> (d0 * 64 + d1)>, 3>
-  return
-}
-
-module attributes {transform.with_named_sequence} {
-  transform.named_sequence @__transform_main(%arg1: !transform.any_op {transform.readonly}) {
-    %0 = transform.structured.match ops{["func.func"]} in %arg1 : (!transform.any_op) -> !transform.any_op
-    transform.memref.erase_dead_alloc_and_stores %0 : (!transform.any_op) -> ()
-    transform.yield
-  }
-}
-
-// -----
-
 // CHECK-LABEL: @store_to_load
 //  CHECK-SAME:   (%[[ARG:.+]]: vector<4xf32>)
 //   CHECK-NOT:   memref.alloc()
